# 后端

## 1. 定时任务

1. 在启动类上加注解

```java
@EnableScheduling
public class UserCenterApplication {
    public static void main(String[] args) {
        SpringApplication.run(UserCenterApplication.class, args);
    }
}
```

2. 在方法上添加注解

   ```java
   // cron 秒 分 时 日 月 年（每天这一刻执行）
   @Scheduled(cron = "0 26 22 * * *")
   public void doPreCacheRecommendUser() {}
   ```

用途：

**缓存预热**（数据量大时，可以用定时任务将数据提前写入缓存，提高第一次访问的数据）

## 2. 分布式锁（基于 redisson）

单机锁：用于**一台**服务器的同步执行

分布式锁：用于**多台**服务器之间的同步执行

1. 依赖

   redisson 是 redis 的一个客户端

   ```xml
   <dependency>
       <groupId>org.redisson</groupId>
       <artifactId>redisson</artifactId>
       <version>3.19.1</version>
   </dependency>
   ```

2. 配置

   

   ```yaml
   # redis 配置
   spring:
     redis:
       port: 6379
       host: localhost
       database: 1
   ```

   ```java
   import lombok.Data;
   import org.redisson.Redisson;
   import org.redisson.api.RedissonClient;
   import org.redisson.config.Config;
   import org.springframework.boot.context.properties.ConfigurationProperties;
   import org.springframework.context.annotation.Bean;
   import org.springframework.context.annotation.Configuration;
   
   /**
    * redisson 配置类
    * @author daqi
    * @date 2023/1/22
    */
   @Configuration
   @ConfigurationProperties("spring.redis")
   @Data
   public class RedissonConfig {
   
       private String host;
   
       private String port; 
       @Bean
       public RedissonClient redissonClient() {
           // 1. Create config object
           Config config = new Config();
           String redisAddress = String.format("redis://%s:%s",host,port);
           config.useSingleServer().setAddress(redisAddress).setDatabase(3);
           RedissonClient redissonClient = Redisson.create(config);
           return redissonClient;
   
       }
   }
   ```

3. 使用

   ```java
   // 项目：类：方法：锁
   RLock lock = redissonClient.getLock("yupao:precachejob:doCache:lock");
   try {
       // tryLock （最长取锁时间，超时 false；过期时间，执行时间超过过期时间，锁将释放；时间单位）
       // 过期时间使用 -1 可以续期；第一个参数是人走了，下个人进来的时间，0 表示只执行一次
       if(lock.tryLock(0,-1,TimeUnit.MILLISECONDS)){
           System.out.println("currentLock:" + Thread.currentThread().getId());
           // 例子 --------------
           for (Long userId : userIds) {
                       ValueOperations<String, Object> redisOps = redisTemplate.opsForValue();
                       String redisKey = String.format("yupao:user:recommend:%s",userId);
                       QueryWrapper<User> queryWrapper = new QueryWrapper<>();
                       Page<User> userPage = userService.page(new Page<>(1, 20), queryWrapper)
          
               // 存入缓存
               try {
                   redisOps.set(redisKey,userPage,1, TimeUnit.MINUTES);
               } catch (Exception e) {
                   log.error("redis set key error",e);
               }
           }
       }
       // 要加锁的逻辑代码 -----------------
   } catch (InterruptedException e) {
       log.error("PreCacheJob error",e);
   } finally {
       if (lock.isHeldByCurrentThread()) {
           System.out.println("unlock:" + Thread.currentThread().getId());
           lock.unlock();
       }
   }
   ```

## 3. 统一全局返回类

### 1. 通用返回类

```java
import lombok.Data;
import java.io.Serializable;

/** 通用返回类
 * @author daqi
 * @date 2023/1/16
 */
@Data
public class BaseResponse<T> implements Serializable {
    /**
     * 返回状态值
     */
    private int code;
    /**
     * 返回数据
     */
    private T data;
    /**
     * 返回概括信息
     */
    private String message;
    /**
     * 详细描述
     */
    private String description;

    public BaseResponse(int code, T data, String message,String description) {
        this.code = code;
        this.data = data;
        this.message = message;
        this.description = description;
    }


    public BaseResponse(int code, T data,String message) {
        this(code,data,message,"");
    }
    public BaseResponse(int code, T data) {
        this(code,data,"","");
    }
    public BaseResponse(ErrorCode errorCode) {
        this(errorCode.getCode(),null,errorCode.getMessage(),errorCode.getDescription());
    }
}
```

###  2. 请求返回工具类

不需要自己 new 返回类，提供一些重载方法

```java
package com.battlegao.usercenter.common;

/**
 * 请求返回工具类
 * @author daqi
 * @date 2023/1/16
 */
public class ResultUtils {
    /**
     * 成功
     * @param data
     * @param <T>
     * @return
     */
    public static <T> BaseResponse<T> success(T data) {
        return new BaseResponse<T>(0,data,"ok");
    }

    /**
     * 失败
     * @param errorCode
     * @return
     */
    public static  BaseResponse error(ErrorCode errorCode) {
        return new BaseResponse(errorCode);
    }

    /**
     * 失败
     * @param errorCode
     * @return
     */
    public static  BaseResponse error(ErrorCode errorCode,String message,String description) {
        return new BaseResponse(errorCode.getCode(),null,message,description);
    }

    /**
     * 请求失败
     * @param code
     * @param message
     * @param description
     * @return
     */
    public static  BaseResponse error(int code,String message,String description) {
        return new BaseResponse(code,null,message,description);
    }

    /**
     * 失败
     * @param errorCode
     * @return
     */
    public static  BaseResponse error(ErrorCode errorCode,String description) {
        return new BaseResponse(errorCode.getCode(),null,errorCode.getMessage(),description);
    }

}
```

### 3. 使用

在 **controller** 中使用，统一返回

```java
@GetMapping("/match")
public BaseResponse<List<User>> matchUsers(long num,HttpServletRequest request) {
    if (num <= 0 || num > 20) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR);
    }
    User loginUser = userService.getLoginUser(request);
    return ResultUtils.success(userService.matchUsers(num,loginUser));
}
```

## 4. 统一异常处理

### 1. 异常枚举类

```java
import lombok.Getter;
import lombok.Setter;
/**
 * 异常枚举
 *
 * @author daqi
 * @date 2023/1/16
 */
@Getter
public enum ErrorCode {
    SUCCESS(0, "ok", ""),
    PARAMS_ERROR(40000, "请求参数错误", ""),
    NULL_ERROR(40001, "请求数据为空", ""),
    NOT_LOGIN(40100, "未登录", ""),
    NO_AUTH(40101, "无权限", ""),
    FORBIDDEN(40300, "禁止访问", ""),
    SYSTEM_ERROR(50000, "系统内部错误", ""),
    OPERATION_FAILED(50100, "操作失败", "");

    private final int code;
    private final String message;
    private final String description;

    ErrorCode(int code, String message, String description) {
        this.code = code;
        this.message = message;
        this.description = description;
    }
}
```

### 2. 封装业务异常类（自定义异常）

```java

/**
 * 业务异常封装类
 * @author daqi
 * @date 2023/1/16
 */
@Data
public class BusinessException extends RuntimeException{
    private int code;
    private String description;

    public BusinessException(String message,int code, String description) {
        super(message);
        this.code = code;
        this.description = description;
    }

    public BusinessException(ErrorCode errorCode) {
        super(errorCode.getMessage());
        this.code = errorCode.getCode();
        this.description = errorCode.getDescription();
    }
    public BusinessException(ErrorCode errorCode,String description) {
        super(errorCode.getMessage());
        this.code = errorCode.getCode();
        this.description = description;
    }
}
```

### 3. 全局异常处理

```java
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

/**
 * 全局异常处理类
 * @author daqi
 * @date 2023/1/16
 */
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    @ExceptionHandler(BusinessException.class)
    public BaseResponse businessExceptionHandler(BusinessException e) {
        log.error("businessException:"+e.getMessage(),e);
        return ResultUtils.error(e.getCode(),e.getMessage(),e.getDescription());
    }

    @ExceptionHandler(RuntimeException.class)
    public BaseResponse runtimeExceptionHandler(RuntimeException e) {
        log.error("runtimeException",e);
        return ResultUtils.error(ErrorCode.SYSTEM_ERROR,e.getMessage(),"");
    }
}
```

### 4. 使用

例子

```java
@Override
public long userRegister(String userAccount, String userPassword, String checkPassword, String planetCode) {
    // 1. 校验
    if (StringUtils.isAnyBlank(userAccount, userPassword, checkPassword, planetCode)) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "参数为空");
    }
    if (userAccount.length() < 4) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "用户账号过短");
    }
    if (userPassword.length() < 8 || checkPassword.length() < 8) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "用户密码过短");
    }
    // 星球编号长度校验
    if (planetCode.length() > 5) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "星球编号过长");
    }
    // 用户不能包含特殊字符
    String validPattern = "[\\\\u00A0\\\\s\\\"`~!@#$%^&*()+=|{}':;',\\\\[\\\\].<>/?~！@#￥%……&*（）——+|{}【】‘；：”“’。，、？]";
    Matcher matcher = Pattern.compile(validPattern).matcher(userAccount);
    if (!matcher.find()) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "用户账号不能包含特殊字符");
    }
    // 密码和校验密码相同
    if (!userPassword.equals(checkPassword)) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "两次密码错误");
    }


    // 账号不能重复
    QueryWrapper<User> queryWrapper = new QueryWrapper<>();
    queryWrapper.eq("userAccount", userAccount);
    long count = this.count(queryWrapper);
    if (count > 0) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "账号已存在");
    }

    // 星球编号不能重复
    queryWrapper = new QueryWrapper<>();
    queryWrapper.eq("planetCode", planetCode);
    count = this.count(queryWrapper);
    if (count > 0) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "星球编号已存在");
    }

    // 2. 加密
    String encryptPassword = DigestUtils.md5DigestAsHex((SALT + userPassword).getBytes());

    // 3。 插入数据
    User user = new User();
    user.setUserPassword(encryptPassword);
    user.setUserAccount(userAccount);
    user.setPlanetCode(planetCode);
    boolean saveResult = this.save(user);
    if (!saveResult) {
        throw new BusinessException(ErrorCode.OPERATION_FAILED, "插入数据失败");
    }
    return user.getId();
}
```

## 5. redis 操作

### 1. spring-data-redis

> 使用 spring-boot-starter-data-redis 操作 redis

1. 依赖

```xml
<!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-data-redis -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
    <version>2.6.4</version>
</dependency>

```

2. 使用

   ```java
   // 存值
   redisTemplate.opsForValue().set("battlegaoInt",1);
   // 取值
   String battlegaoString = (String) redisTemplate.opsForValue().get("battlegaoString");
   ```

3. 其他配置（使支持 RedisTemplate<String,Object>）

   ```java
   import org.springframework.context.annotation.Bean;
   import org.springframework.context.annotation.Configuration;
   import org.springframework.data.redis.connection.RedisConnectionFactory;
   import org.springframework.data.redis.core.RedisTemplate;
   import org.springframework.data.redis.serializer.RedisSerializer;
   
   /**
    *  redisTemplate 配置类
    * @author daqi
    * @date 2023/1/21
    */
   @Configuration
   public class RedisTemplateConfig {
   
       @Bean
       public RedisTemplate<String,Object> redisTemplate(RedisConnectionFactory redisConnectionFactory) {
           RedisTemplate<String, Object> redisTemplate = new RedisTemplate<>();
           redisTemplate.setConnectionFactory(redisConnectionFactory);
           redisTemplate.setKeySerializer(RedisSerializer.string());
   
           return redisTemplate;
       }
   }
   ```

###  2. spring-session-data-redis

>  使用 spring-session-data-redis **自动同步** session 数据到 redis 中，实现 **session 共享**

1. 依赖

```xml
<!-- https://mvnrepository.com/artifact/org.springframework.session/spring-session-data-redis -->
<dependency>
    <groupId>org.springframework.session</groupId>
    <artifactId>spring-session-data-redis</artifactId>
    <version>2.6.3</version>
</dependency>
```

2. 配置

   ```yaml
   spring:
     # session 配置，过期时间（分钟）
     session:
       timeout: 86400
       store-type: redis
   ```

3. 使用

   ```java
   request.getSession().setAttribute(USER_LOGIN_STATE, safetyUser);
   ```

![image-20230126193925931](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/16782/image-20230126193925931.png)

## 6. Swagger + knife4j

1. 依赖

   ```xml
   <dependency>
       <groupId>com.github.xiaoymin</groupId>
       <artifactId>knife4j-openapi2-spring-boot-starter</artifactId>
       <version>4.0.0</version>
   </dependency>
   ```

2. 配置

   预览：http://localhost:8080/api/doc.html（例子中端口要更改，/api/ 是项目中加的路径）

   ```yaml
   knife4j:
     enable: true
     # 开启生产环境屏蔽
   #  production: true
     openapi:
       title: 鱼皮用户中心管理
       description: 用户中心
       # aaa"
       email: xiaoymin@foxmail.com
       concat: 八一菜刀
       url: https://cymgc.top
       version: v4.0
       license: Apache 2.0
       license-url: https://stackoverflow.com/
       terms-of-service-url: https://stackoverflow.com/
       group:
         test1:
           group-name: 用户中心 api
           api-rule: package
           api-rule-resources:
             - com.battlegao.usercenter.controller
   ```

## 7. json 序列化 （Gson）

1. 依赖

   ```xml
   <!-- https://mvnrepository.com/artifact/com.google.code.gson/gson -->
   <dependency>
       <groupId>com.google.code.gson</groupId>
       <artifactId>gson</artifactId>
       <version>2.9.0</version>
   </dependency>
   ```

2. 使用

   ```java
   Gson gson = new Gson();
   // 3. 标签列表转为 java 对象，遍历用户传过来的标签名字，判断是否包含在标签列表中
   Set<String> tempTagSet = gson.fromJson(tagJsonStr, new TypeToken<Set<String>>() {
   }.getType());
   tempTagSet = Optional.ofNullable(tempTagSet).orElse(new HashSet<>())
   ```



## 8. 跨域问题

在控制器类上添加 @CrossOrigin 注解，并允许 cookie 传递

```java
@RestController
@RequestMapping("/user")
@CrossOrigin(origins = {"http://localhost:3000"},allowCredentials = "true")
public class UserController {}
```

## 9. 编辑距离算法

编辑距离算法代码，可以判断与目标最相似的值，返回需要通过增删改操作后变成目标值的最小步骤

```java
import java.util.List;
import java.util.Objects;

/**
 * @author daqi
 * @date 2023/1/25
 */
public class AlgorithmUtils {

    public static int minDistance(List<String> tagList1, List<String> tagList2){
        int n = tagList1.size();
        int m = tagList2.size();

        if(n * m == 0)
            return n + m;

        int[][] d = new int[n + 1][m + 1];
        for (int i = 0; i < n + 1; i++){
            d[i][0] = i;
        }

        for (int j = 0; j < m + 1; j++){
            d[0][j] = j;
        }

        for (int i = 1; i < n + 1; i++){
            for (int j = 1; j < m + 1; j++){
                int left = d[i - 1][j] + 1;
                int down = d[i][j - 1] + 1;
                int left_down = d[i - 1][j - 1];
                if (!Objects.equals(tagList1.get(i - 1), tagList2.get(j - 1)))
                    left_down += 1;
                d[i][j] = Math.min(left, Math.min(down, left_down));
            }
        }
        return d[n][m];
    }

    /**
     * 编辑算法，判断相似字符串
     * @param word1
     * @param word2
     * @return
     */
    public static int minDistance(String word1, String word2){
        int n = word1.length();
        int m = word2.length();

        if(n * m == 0)
            return n + m;

        int[][] d = new int[n + 1][m + 1];
        for (int i = 0; i < n + 1; i++){
            d[i][0] = i;
        }

        for (int j = 0; j < m + 1; j++){
            d[0][j] = j;
        }

        for (int i = 1; i < n + 1; i++){
            for (int j = 1; j < m + 1; j++){
                int left = d[i - 1][j] + 1;
                int down = d[i][j - 1] + 1;
                int left_down = d[i - 1][j - 1];
                if (word1.charAt(i - 1) != word2.charAt(j - 1))
                    left_down += 1;
                d[i][j] = Math.min(left, Math.min(down, left_down));
            }
        }
        return d[n][m];
    }
}
```

## 10. 事务

在方法上添加注解 @Transactional，rollbackFor 为发生指定的异常就回滚

```java
@Transactional(rollbackFor = Exception.class)
public long addTeam(Team team, User userLogin) {}
```

# 前端

## 1. 写 css 代码

可以在浏览器使用开发者模式（F12）写样式，然后粘贴到代码中

## 2. 路由

1. router：负责转发路由
2. route：负责获取路由传递的数据

## 3. 开启携带 cookie

myAxios 是对 axios 的自定义封装

```js
// 设置超时时间
myAxios.defaults.timeout = 50000
// 开启携带 cookie
myAxios.defaults.withCredentials = true
```